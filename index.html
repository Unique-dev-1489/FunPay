<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fun Pay - Educational Payment App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .phone-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 480px;
            margin: 0 auto;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .transaction-item {
            transition: all 0.2s ease;
        }
        .transaction-item:hover {
            background-color: #f9fafb;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .debit-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .debit-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .chip {
            width: 40px;
            height: 30px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 4px;
            position: relative;
        }
        .pin-input {
            letter-spacing: 8px;
            text-align: center;
            font-size: 24px;
        }
        .success-animation {
            animation: successPulse 1.5s ease-in-out;
        }
        @keyframes successPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .big-amount {
            font-size: 3rem;
            font-weight: bold;
            line-height: 1;
        }
        .success-message {
            background-color: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .success-message i {
            color: #22c55e;
            margin-right: 10px;
        }
        #qr-reader {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
        }
        #qr-reader video {
            width: 100%;
            height: auto;
        }
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #qrcode {
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
         const firebaseConfig = {
  apiKey: "AIzaSyD_jqTqBlb2Dk-muoOCGKU9eQbeQvNFKWY",
  authDomain: "fun-pay-a2cf0.firebaseapp.com",
  databaseURL: "https://fun-pay-a2cf0-default-rtdb.firebaseio.com",
  projectId: "fun-pay-a2cf0",
  storageBucket: "fun-pay-a2cf0.firebasestorage.app",
  messagingSenderId: "238563276663",
  appId: "1:238563276663:web:313b1cf7f5bd6dbd075372"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        // App state
        let currentUser = null;
        let appSettings = {
            bankName: "Children Bank of India",
            defaultProfileIcon: "https://picsum.photos/seed/default/200/200.jpg",
            userInviteCode: "FUNUSER2024"
        };
        
        // Store last transaction for receipt
        let lastTransaction = null;
        
        // QR Code scanner instance
        let html5QrcodeScanner = null;
        
        // Scanned user data
        let scannedUserData = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    showScreen('home');
                } else {
                    showScreen('welcome');
                }
            });

            // Load app settings
            database.ref('settings').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    appSettings = { ...appSettings, ...snapshot.val() };
                    updateBankName();
                }
            });
        });

        // Generate unique account number
        function generateAccountNumber() {
            return 'FP' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        // Load user data
        function loadUserData(uid) {
            database.ref('users/' + uid).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('userBalance').textContent = '₹' + userData.balance.toFixed(2);
                    document.getElementById('userName').textContent = userData.displayName || 'User';
                    document.getElementById('profileName').textContent = userData.displayName || 'User';
                    document.getElementById('profileEmail').textContent = userData.email;
                    document.getElementById('cardHolderName').textContent = userData.displayName || 'USER';
                    document.getElementById('cardNumber').textContent = formatCardNumber(userData.accountNumber);
                    document.getElementById('cardExpiry').textContent = userData.expiryDate || '12/28';
                    
                    // Update card balance
                    document.getElementById('cardBalance').textContent = '₹' + userData.balance.toFixed(2);
                    
                    if (userData.profileIcon) {
                        document.getElementById('profileIcon').src = userData.profileIcon;
                        document.getElementById('homeProfileIcon').src = userData.profileIcon;
                    }
                }
            });

            // Load transactions
            loadTransactions(uid);
            
            // Load notifications
            loadNotifications(uid);
        }

        // Format card number
        function formatCardNumber(number) {
            return number.replace(/(\w{4})(\w{4})(\w{4})(\w{4})/, '$1 $2 $3 $4');
        }

        // Load transactions
        function loadTransactions(uid) {
            const transactionsRef = database.ref('transactions/' + uid);
            transactionsRef.orderByChild('timestamp').limitToLast(10).on('value', snapshot => {
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const transactions = snapshot.val();
                    Object.keys(transactions).reverse().forEach(key => {
                        const transaction = transactions[key];
                        const transactionEl = createTransactionElement(transaction);
                        transactionsList.appendChild(transactionEl);
                    });
                } else {
                    transactionsList.innerHTML = '<p class="text-gray-500 text-center py-4">No transactions yet</p>';
                }
            });
        }

        // Create transaction element
        function createTransactionElement(transaction) {
            const div = document.createElement('div');
            div.className = 'transaction-item p-3 border-b border-gray-100 cursor-pointer fade-in';
            div.onclick = () => showTransactionDetails(transaction);
            
            const isCredit = transaction.type === 'credit' || transaction.type === 'request';
            const icon = isCredit ? 'fa-arrow-down text-green-500' : 'fa-arrow-up text-red-500';
            const name = transaction.from === currentUser.displayName ? 'To: ' + transaction.to : 'From: ' + transaction.from;
            
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm">${name}</p>
                            <p class="text-xs text-gray-500">${transaction.note || 'Payment'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-medium ${isCredit ? 'text-green-500' : 'text-red-500'}">
                            ${isCredit ? '+' : '-'}₹${transaction.amount.toFixed(2)}
                        </p>
                        <p class="text-xs text-gray-500">${formatDate(transaction.timestamp)}</p>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Load notifications
        function loadNotifications(uid) {
            const notificationsRef = database.ref('notifications/' + uid);
            notificationsRef.orderByChild('timestamp').limitToLast(10).on('value', snapshot => {
                const notificationsList = document.getElementById('notificationsList');
                notificationsList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const notifications = snapshot.val();
                    Object.keys(notifications).reverse().forEach(key => {
                        const notification = notifications[key];
                        const notificationEl = createNotificationElement(notification);
                        notificationsList.appendChild(notificationEl);
                    });
                } else {
                    notificationsList.innerHTML = '<p class="text-gray-500 text-center py-4">No notifications</p>';
                }
            });
        }

        // Create notification element
        function createNotificationElement(notification) {
            const div = document.createElement('div');
            div.className = 'p-3 border-b border-gray-100 fade-in';
            
            div.innerHTML = `
                <div class="flex items-start">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-bell text-blue-500 text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${notification.title}</p>
                        <p class="text-xs text-gray-600 mt-1">${notification.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(notification.timestamp)}</p>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            if (screenId === 'home') {
                document.getElementById('homeNavBtn').classList.add('text-blue-600');
                document.getElementById('homeNavBtn').classList.remove('text-gray-500');
            } else if (screenId === 'history') {
                document.getElementById('historyNavBtn').classList.add('text-blue-600');
                document.getElementById('historyNavBtn').classList.remove('text-gray-500');
            } else if (screenId === 'profile') {
                document.getElementById('profileNavBtn').classList.add('text-blue-600');
                document.getElementById('profileNavBtn').classList.remove('text-gray-500');
            }
            
            // Stop QR scanner when leaving scan screen
            if (screenId !== 'scanQR' && html5QrcodeScanner) {
                html5QrcodeScanner.stop();
            }
        }

        // Sign up user
        function signUpUser() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const displayName = document.getElementById('signupName').value;
            const inviteCode = document.getElementById('signupInviteCode').value;
            const pin = document.getElementById('signupPin').value;
            const confirmPin = document.getElementById('signupConfirmPin').value;
            
            if (!email || !password || !displayName || !inviteCode || !pin) {
                alert('Please fill all fields');
                return;
            }
            
            if (inviteCode !== appSettings.userInviteCode) {
                alert('Invalid invite code');
                return;
            }
            
            if (pin.length !== 4 || pin !== confirmPin) {
                alert('PIN must be 4 digits and match');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    const accountNumber = generateAccountNumber();
                    const expiryDate = '12/' + (new Date().getFullYear() + 5).toString().substr(2);
                    
                    // Create user in database
                    database.ref('users/' + user.uid).set({
                        uid: user.uid,
                        email: email,
                        displayName: displayName,
                        accountNumber: accountNumber,
                        pin: pin,
                        expiryDate: expiryDate,
                        balance: 1000, // Starting balance
                        profileIcon: appSettings.defaultProfileIcon,
                        createdAt: Date.now()
                    });
                    
                    // Send welcome notification
                    database.ref('notifications/' + user.uid).push({
                        title: 'Welcome to Fun Pay!',
                        message: `Your account ${accountNumber} has been created with ₹1000 starting balance.`,
                        timestamp: Date.now()
                    });
                    
                    return user.updateProfile({ displayName: displayName });
                })
                .catch(error => {
                    alert(error.message);
                });
        }

        // Sign in
        function signIn() {
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const accountNumber = document.getElementById('signinAccountNumber').value;
            
            if (!email || !password || !accountNumber) {
                alert('Please fill all fields');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Verify account number
                    return database.ref('users/' + userCredential.user.uid).once('value');
                })
                .then(snapshot => {
                    if (snapshot.exists() && snapshot.val().accountNumber === accountNumber) {
                        // Valid login
                    } else {
                        throw new Error('Invalid account number');
                    }
                })
                .catch(error => {
                    alert(error.message);
                    auth.signOut();
                });
        }

        // Sign out
        function signOut() {
            auth.signOut();
        }

        // Verify PIN for transactions
        function verifyPin(callback) {
            const pin = prompt('Enter your 4-digit PIN:');
            if (pin && pin.length === 4) {
                database.ref('users/' + currentUser.uid + '/pin').once('value').then(snapshot => {
                    if (snapshot.val() === pin) {
                        callback();
                    } else {
                        alert('Invalid PIN');
                    }
                });
            }
        }

        // Send money
        function sendMoney() {
            const recipient = document.getElementById('recipient').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const note = document.getElementById('note').value;
            
            if (!recipient || !amount || amount <= 0) {
                alert('Please fill all fields with valid values');
                return;
            }
            
            verifyPin(() => {
                // Get current user balance
                database.ref('users/' + currentUser.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    
                    if (userData.balance < amount) {
                        alert('Insufficient balance');
                        return;
                    }
                    
                    // Find recipient by account number or email
                    database.ref('users').orderByChild('accountNumber').equalTo(recipient).once('value').then(recipientSnapshot => {
                        if (!recipientSnapshot.exists()) {
                            database.ref('users').orderByChild('email').equalTo(recipient).once('value').then(emailSnapshot => {
                                if (!emailSnapshot.exists()) {
                                    alert('Recipient not found');
                                    return;
                                }
                                processTransaction(emailSnapshot.val(), amount, note, userData);
                            });
                        } else {
                            processTransaction(recipientSnapshot.val(), amount, note, userData);
                        }
                    });
                });
            });
        }

        // Process transaction
        function processTransaction(recipientData, amount, note, senderData) {
            const recipientId = Object.keys(recipientData)[0];
            const recipient = recipientData[recipientId];
            
            // Update balances
            const updates = {};
            updates['users/' + currentUser.uid + '/balance'] = senderData.balance - amount;
            updates['users/' + recipientId + '/balance'] = recipient.balance + amount;
            
            // Generate transaction ID
            const transactionId = 'TXN' + Date.now();
            
            // Add transactions
            const transactionData = {
                transactionId: transactionId,
                from: senderData.displayName,
                to: recipient.displayName,
                amount: amount,
                note: note,
                timestamp: Date.now(),
                type: 'debit'
            };
            
            updates['transactions/' + currentUser.uid + '/' + Date.now()] = transactionData;
            
            const creditTransaction = { ...transactionData, type: 'credit' };
            updates['transactions/' + recipientId + '/' + Date.now()] = creditTransaction;
            
            // Send notification to recipient
            updates['notifications/' + recipientId + '/' + Date.now()] = {
                title: 'Money Received',
                message: `${senderData.displayName} sent you ₹${amount.toFixed(2)}`,
                timestamp: Date.now()
            };
            
            // Store transaction for receipt
            lastTransaction = {
                ...transactionData,
                senderAccountNumber: senderData.accountNumber,
                recipientAccountNumber: recipient.accountNumber,
                transactionId: transactionId
            };
            
            // Update database
            database.ref().update(updates).then(() => {
                // Clear form
                document.getElementById('recipient').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('note').value = '';
                
                // Show success screen
                showPaymentSuccess();
            });
        }

        // Show payment success screen
        function showPaymentSuccess() {
            if (!lastTransaction) return;
            
            // Update success screen with transaction details
            document.getElementById('successRecipient').textContent = lastTransaction.to;
            document.getElementById('successAmount').textContent = '₹' + lastTransaction.amount.toFixed(2);
            document.getElementById('successNote').textContent = lastTransaction.note || 'Payment';
            document.getElementById('successDate').textContent = formatDate(lastTransaction.timestamp);
            document.getElementById('successTransactionId').textContent = lastTransaction.transactionId;
            
            // Show the screen with animation
            showScreen('paymentSuccess');
            
            // Add animation class
            const successIcon = document.getElementById('successIcon');
            successIcon.classList.add('success-animation');
            
            // Remove animation class after animation completes
            setTimeout(() => {
                successIcon.classList.remove('success-animation');
            }, 1500);
        }

        // Share transaction
        function shareTransaction() {
            if (!lastTransaction) return;
            
            const shareText = `Payment Successful!\n\nPaid: ₹${lastTransaction.amount.toFixed(2)}\nTo: ${lastTransaction.to}\nNote: ${lastTransaction.note || 'Payment'}\nDate: ${formatDate(lastTransaction.timestamp)}\nTransaction ID: ${lastTransaction.transactionId}\n\nSent via Fun Pay - Educational Payment App`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Fun Pay - Payment Successful',
                    text: shareText
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Transaction details copied to clipboard!');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Unable to share. Please try again.');
                });
            }
        }

        // Download PDF receipt
        function downloadPDFReceipt() {
            if (!lastTransaction) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add logo/header
            doc.setFontSize(20);
            doc.setTextColor(66, 133, 244); // Blue color
            doc.text('Fun Pay', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text('Educational Payment Platform', 105, 27, { align: 'center' });
            
            // Add receipt title
            doc.setFontSize(16);
            doc.setTextColor(0);
            doc.text('Payment Receipt', 105, 40, { align: 'center' });
            
            // Add transaction details
            doc.setFontSize(12);
            doc.text('Transaction Details', 20, 55);
            
            doc.setFontSize(10);
            doc.text(`Transaction ID: ${lastTransaction.transactionId}`, 20, 65);
            doc.text(`Date: ${formatDate(lastTransaction.timestamp)}`, 20, 72);
            doc.text(`Status: Successful`, 20, 79);
            
            // Add payment details
            doc.setFontSize(12);
            doc.text('Payment Details', 20, 95);
            
            doc.setFontSize(10);
            doc.text(`From: ${lastTransaction.from}`, 20, 105);
            doc.text(`To: ${lastTransaction.to}`, 20, 112);
            doc.text(`Amount: ₹${lastTransaction.amount.toFixed(2)}`, 20, 119);
            doc.text(`Note: ${lastTransaction.note || 'Payment'}`, 20, 126);
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('This is an educational receipt. No real money was involved.', 105, 280, { align: 'center' });
            doc.text('© 2023 Fun Pay - Educational Platform', 105, 285, { align: 'center' });
            
            // Save the PDF
            doc.save(`FunPay_Receipt_${lastTransaction.transactionId}.pdf`);
        }

        // Request money
        function requestMoney() {
            const recipient = document.getElementById('requestRecipient').value;
            const amount = parseFloat(document.getElementById('requestAmount').value);
            const note = document.getElementById('requestNote').value;
            
            if (!recipient || !amount || amount <= 0) {
                alert('Please fill all fields with valid values');
                return;
            }
            
            // Find recipient
            database.ref('users').orderByChild('accountNumber').equalTo(recipient).once('value').then(recipientSnapshot => {
                if (!recipientSnapshot.exists()) {
                    database.ref('users').orderByChild('email').equalTo(recipient).once('value').then(emailSnapshot => {
                        if (!emailSnapshot.exists()) {
                            alert('Recipient not found');
                            return;
                        }
                        processRequest(emailSnapshot.val(), amount, note);
                    });
                } else {
                    processRequest(recipientSnapshot.val(), amount, note);
                }
            });
        }

        // Process request
        function processRequest(recipientData, amount, note) {
            const recipientId = Object.keys(recipientData)[0];
            const recipient = recipientData[recipientId];
            
            // Send notification to recipient
            database.ref('notifications/' + recipientId).push({
                title: 'Money Request',
                message: `${currentUser.displayName} requested ₹${amount.toFixed(2)}`,
                timestamp: Date.now(),
                requestId: Date.now(),
                requestFrom: currentUser.uid,
                amount: amount,
                note: note
            });
            
            alert('Request sent successfully!');
            document.getElementById('requestRecipient').value = '';
            document.getElementById('requestAmount').value = '';
            document.getElementById('requestNote').value = '';
            showScreen('home');
        }

        // Upload profile picture
        function uploadProfilePicture() {
            const file = document.getElementById('profilePictureInput').files[0];
            
            if (!file) return;
            
            const storageRef = storage.ref('profilePictures/' + currentUser.uid);
            const uploadTask = storageRef.put(file);
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Progress indicator
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                },
                (error) => {
                    alert(error.message);
                },
                () => {
                    // Get download URL
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        // Update user profile
                        database.ref('users/' + currentUser.uid + '/profileIcon').set(downloadURL);
                        document.getElementById('profileIcon').src = downloadURL;
                        document.getElementById('homeProfileIcon').src = downloadURL;
                    });
                }
            );
        }

        // Show transaction details
        function showTransactionDetails(transaction) {
            document.getElementById('detailFrom').textContent = transaction.from;
            document.getElementById('detailTo').textContent = transaction.to;
            document.getElementById('detailAmount').textContent = '₹' + transaction.amount.toFixed(2);
            document.getElementById('detailNote').textContent = transaction.note || 'No note';
            document.getElementById('detailDate').textContent = formatDate(transaction.timestamp);
            document.getElementById('detailType').textContent = transaction.type === 'credit' ? 'Received' : 'Sent';
            document.getElementById('detailType').className = transaction.type === 'credit' ? 'text-green-500' : 'text-red-500';
            
            // Add transaction ID if available
            if (transaction.transactionId) {
                document.getElementById('detailTransactionId').textContent = transaction.transactionId;
                document.getElementById('detailTransactionIdRow').style.display = 'flex';
            } else {
                document.getElementById('detailTransactionIdRow').style.display = 'none';
            }
            
            // Show success message
            const successMessage = document.getElementById('transactionSuccessMessage');
            successMessage.style.display = 'flex';
            
            // Update success message text based on transaction type
            const successText = transaction.type === 'credit' ? 'Money received successfully!' : 'Money sent successfully!';
            document.getElementById('successMessageText').textContent = successText;
            
            showScreen('transactionDetails');
        }

        // Change PIN
        function changePin() {
            const currentPin = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmNewPin').value;
            
            if (!currentPin || !newPin || !confirmPin) {
                alert('Please fill all fields');
                return;
            }
            
            if (newPin.length !== 4) {
                alert('New PIN must be 4 digits');
                return;
            }
            
            if (newPin !== confirmPin) {
                alert('New PIN and confirmation do not match');
                return;
            }
            
            // Verify current PIN
            database.ref('users/' + currentUser.uid + '/pin').once('value').then(snapshot => {
                if (snapshot.val() === currentPin) {
                    // Update PIN
                    database.ref('users/' + currentUser.uid + '/pin').set(newPin).then(() => {
                        alert('PIN changed successfully!');
                        document.getElementById('currentPin').value = '';
                        document.getElementById('newPin').value = '';
                        document.getElementById('confirmNewPin').value = '';
                        showScreen('profile');
                    });
                } else {
                    alert('Current PIN is incorrect');
                }
            });
        }

        // Update bank name in UI
        function updateBankName() {
            document.getElementById('bankName').textContent = appSettings.bankName;
            document.getElementById('homeBankName').textContent = appSettings.bankName;
        }

        // Utility functions
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // QR Code Functions
        
        // Generate QR Code
        function generateQRCode() {
            // Get current user data
            database.ref('users/' + currentUser.uid).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    
                    // Clear previous QR code if exists
                    document.getElementById('qrcode').innerHTML = '';
                    
                    // Create QR code data
                    const qrData = JSON.stringify({
                        uid: userData.uid,
                        accountNumber: userData.accountNumber,
                        displayName: userData.displayName,
                        bankName: appSettings.bankName
                    });
                    
                    // Generate QR code
                    new QRCode(document.getElementById('qrcode'), {
                        text: qrData,
                        width: 200,
                        height: 200,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    
                    // Update QR code screen with user details
                    document.getElementById('qrAccountNumber').textContent = userData.accountNumber;
                    document.getElementById('qrDisplayName').textContent = userData.displayName;
                    document.getElementById('qrBankName').textContent = appSettings.bankName;
                    
                    // Show QR code screen
                    showScreen('showQR');
                }
            });
        }
        
        // Start QR Scanner
        function startQRScanner() {
            showScreen('scanQR');
            
            // Initialize scanner if not already initialized
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("qr-reader");
            }
            
            // Start scanning
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    // QR code scanned successfully
                    try {
                        const userData = JSON.parse(decodedText);
                        
                        // Store scanned user data
                        scannedUserData = userData;
                        
                        // Stop scanner
                        html5QrcodeScanner.stop();
                        
                        // Show payment screen with scanned user data
                        showQRPaymentScreen(userData);
                    } catch (error) {
                        alert('Invalid QR code format');
                    }
                },
                (errorMessage) => {
                    // Handle scan error silently
                }
            ).catch((err) => {
                console.error(`Unable to start scanning: ${err}`);
                alert('Unable to access camera. Please check permissions.');
            });
        }
        
        // Show QR payment screen
        function showQRPaymentScreen(userData) {
            // Update payment screen with user details
            document.getElementById('qrPayAccountNumber').textContent = userData.accountNumber;
            document.getElementById('qrPayDisplayName').textContent = userData.displayName;
            document.getElementById('qrPayBankName').textContent = userData.bankName;
            
            // Clear previous amount
            document.getElementById('qrPayAmount').value = '';
            
            // Show payment screen
            showScreen('qrPay');
        }
        
        // Process QR payment
        function processQRPayment() {
            const amount = parseFloat(document.getElementById('qrPayAmount').value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Verify PIN
            verifyPin(() => {
                // Get current user balance
                database.ref('users/' + currentUser.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    
                    if (userData.balance < amount) {
                        alert('Insufficient balance');
                        return;
                    }
                    
                    // Get recipient data
                    database.ref('users/' + scannedUserData.uid).once('value').then(recipientSnapshot => {
                        if (recipientSnapshot.exists()) {
                            const recipientData = recipientSnapshot.val();
                            
                            // Process transaction
                            processQRTransaction(recipientData, amount, userData);
                        } else {
                            alert('Recipient account not found');
                        }
                    });
                });
            });
        }
        
        // Process QR transaction
        function processQRTransaction(recipientData, amount, senderData) {
            // Update balances
            const updates = {};
            updates['users/' + currentUser.uid + '/balance'] = senderData.balance - amount;
            updates['users/' + recipientData.uid + '/balance'] = recipientData.balance + amount;
            
            // Generate transaction ID
            const transactionId = 'TXN' + Date.now();
            
            // Add transactions
            const transactionData = {
                transactionId: transactionId,
                from: senderData.displayName,
                to: recipientData.displayName,
                amount: amount,
                note: 'QR Code Payment',
                timestamp: Date.now(),
                type: 'debit',
                paymentMethod: 'QR Code'
            };
            
            updates['transactions/' + currentUser.uid + '/' + Date.now()] = transactionData;
            
            const creditTransaction = { ...transactionData, type: 'credit' };
            updates['transactions/' + recipientData.uid + '/' + Date.now()] = creditTransaction;
            
            // Send notification to recipient
            updates['notifications/' + recipientData.uid + '/' + Date.now()] = {
                title: 'Money Received',
                message: `${senderData.displayName} sent you ₹${amount.toFixed(2)} via QR Code`,
                timestamp: Date.now()
            };
            
            // Store transaction for receipt
            lastTransaction = {
                ...transactionData,
                senderAccountNumber: senderData.accountNumber,
                recipientAccountNumber: recipientData.accountNumber,
                transactionId: transactionId
            };
            
            // Update database
            database.ref().update(updates).then(() => {
                // Clear form
                document.getElementById('qrPayAmount').value = '';
                
                // Show success screen
                showPaymentSuccess();
            });
        }
    </script>

    <!-- Welcome/Onboarding Screen -->
    <div id="welcome" class="screen active">
        <div class="phone-container bg-white">
            <div class="flex flex-col items-center justify-center min-h-screen p-6">
                <div class="mb-8 text-center">
                    <div class="w-24 h-24 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 pulse">
                        <i class="fas fa-wallet text-white text-4xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Fun Pay</h1>
                    <p class="text-gray-600">Learn how digital payments work</p>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 w-full">
                    <h3 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Educational Disclaimer
                    </h3>
                    <p class="text-sm text-yellow-700 mb-3">
                        This is an educational app that simulates payment transactions. No real money is involved. 
                        This app is not affiliated with any bank or financial institution and is not approved by any app store.
                    </p>
                    <label class="flex items-center">
                        <input type="checkbox" id="disclaimerCheck" class="mr-2">
                        <span class="text-sm text-yellow-700">I understand this is for educational purposes only</span>
                    </label>
                </div>
                
                <div class="w-full space-y-3">
                    <button onclick="showScreen('signup')" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition disabled:bg-gray-300" id="proceedBtn" disabled>
                        User Sign Up
                    </button>
                    <button onclick="showScreen('signin')" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition">
                        User Sign In
                    </button>
                </div>
                
                <div class="mt-6 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-700 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        User Invite Code: <span class="font-mono font-bold">FUNUSER2024</span>
                    </p>
                </div>
                
                <div class="mt-6 text-center">
                    <p class="text-xs text-gray-500">© 2023 Fun Pay - Educational Platform</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Sign Up Screen -->
    <div id="signup" class="screen">
        <div class="phone-container bg-white">
            <div class="flex flex-col items-center justify-center min-h-screen p-6">
                <div class="mb-8 text-center">
                    <div class="w-20 h-20 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-plus text-white text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Create Account</h2>
                    <p class="text-gray-600 mt-1">Join Fun Pay to learn about payments</p>
                </div>
                
                <div class="w-full space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="signupName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signupEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your email">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signupPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Create a password">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">4-Digit PIN</label>
                        <input type="password" id="signupPin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pin-input" placeholder="••••" maxlength="4">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm PIN</label>
                        <input type="password" id="signupConfirmPin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pin-input" placeholder="••••" maxlength="4">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Invite Code</label>
                        <input type="text" id="signupInviteCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="FUNUSER2024">
                    </div>
                    
                    <button onclick="signUpUser()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                        Sign Up
                    </button>
                    
                    <div class="text-center">
                        <p class="text-sm text-gray-600">
                            Already have an account? 
                            <a href="#" onclick="showScreen('signin')" class="text-blue-500 hover:underline">Sign In</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign In Screen -->
    <div id="signin" class="screen">
        <div class="phone-container bg-white">
            <div class="flex flex-col items-center justify-center min-h-screen p-6">
                <div class="mb-8 text-center">
                    <div class="w-20 h-20 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-sign-in-alt text-white text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2>
                    <p class="text-gray-600 mt-1">Sign in to continue learning</p>
                </div>
                
                <div class="w-full space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signinEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your email">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                        <input type="text" id="signinAccountNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="FPXXXXXXXXX">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="signinPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your password">
                    </div>
                    
                    <button onclick="signIn()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                        Sign In
                    </button>
                    
                    <div class="text-center">
                        <p class="text-sm text-gray-600">
                            Don't have an account? 
                            <a href="#" onclick="showScreen('signup')" class="text-blue-500 hover:underline">Sign Up</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Home/Dashboard Screen -->
    <div id="home" class="screen">
        <div class="phone-container bg-gray-50 pb-20">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-b-3xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-sm opacity-90">Good morning,</p>
                        <h2 class="text-xl font-bold" id="userName">User</h2>
                    </div>
                    <div class="relative">
                        <img id="homeProfileIcon" src="https://picsum.photos/seed/user/200/200.jpg" class="w-12 h-12 rounded-full border-2 border-white">
                        <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-400 rounded-full border-2 border-white"></div>
                    </div>
                    <!-- Scan QR Button -->
                    <button onclick="startQRScanner()" class="w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center">
                        <i class="fas fa-qrcode text-white"></i>
                    </button>
                </div>
                
                <div class="bg-white/20 backdrop-blur rounded-xl p-4">
                    <p class="text-sm opacity-90" id="homeBankName">Children Bank of India</p>
                    <p class="text-3xl font-bold mt-1" id="userBalance">₹0.00</p>
                    <p class="text-xs opacity-75 mt-1">Available Balance</p>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="px-6 mt-6">
                <div class="grid grid-cols-4 gap-4">
                    <button onclick="showScreen('send')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-paper-plane text-blue-500"></i>
                        </div>
                        <span class="text-xs text-gray-700">Send</span>
                    </button>
                    
                    <button onclick="showScreen('request')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-hand-holding-usd text-green-500"></i>
                        </div>
                        <span class="text-xs text-gray-700">Request</span>
                    </button>
                    
                    <button onclick="showScreen('notifications')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow-sm hover:shadow-md transition relative">
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-bell text-orange-500"></i>
                        </div>
                        <span class="text-xs text-gray-700">Alerts</span>
                        <div class="notification-badge">3</div>
                    </button>
                    
                    <button onclick="showScreen('profile')" class="flex flex-col items-center p-3 bg-white rounded-xl shadow-sm hover:shadow-md transition">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-2">
                            <i class="fas fa-credit-card text-purple-500"></i>
                        </div>
                        <span class="text-xs text-gray-700">Card</span>
                    </button>
                </div>
            </div>
            
            <!-- Recent Transactions -->
            <div class="px-6 mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-gray-800">Recent Transactions</h3>
                    <button onclick="showScreen('history')" class="text-blue-500 text-sm hover:underline">View All</button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm" id="transactionsList">
                    <p class="text-gray-500 text-center py-4">No transactions yet</p>
                </div>
            </div>
            
            <!-- Educational Banner -->
            <div class="px-6 mt-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        Remember: This is an educational app. No real money is involved.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav bg-white border-t border-gray-200">
            <div class="grid grid-cols-4 py-2">
                <button onclick="showScreen('home')" class="nav-btn flex flex-col items-center py-2 text-blue-600" id="homeNavBtn">
                    <i class="fas fa-home text-xl mb-1"></i>
                    <span class="text-xs">Home</span>
                </button>
                
                <button onclick="showScreen('history')" class="nav-btn flex flex-col items-center py-2 text-gray-500" id="historyNavBtn">
                    <i class="fas fa-history text-xl mb-1"></i>
                    <span class="text-xs">History</span>
                </button>
                
                <button onclick="showScreen('profile')" class="nav-btn flex flex-col items-center py-2 text-gray-500" id="profileNavBtn">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span class="text-xs">Profile</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Send Money Screen -->
    <div id="send" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-blue-500 text-white p-4 flex items-center">
                <button onclick="showScreen('home')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Send Money</h2>
            </div>
            
            <!-- Payment Method Tabs -->
            <div class="flex border-b border-gray-200">
                <button onclick="document.getElementById('accountMethod').classList.add('active'); document.getElementById('qrMethod').classList.remove('active'); document.getElementById('accountPayment').style.display='block'; document.getElementById('qrPayment').style.display='none';" id="accountMethod" class="flex-1 py-3 text-center font-medium text-blue-600 border-b-2 border-blue-600">
                    Account/Email
                </button>
                <button onclick="document.getElementById('qrMethod').classList.add('active'); document.getElementById('accountMethod').classList.remove('active'); document.getElementById('accountPayment').style.display='none'; document.getElementById('qrPayment').style.display='block';" id="qrMethod" class="flex-1 py-3 text-center font-medium text-gray-500">
                    QR Code
                </button>
            </div>
            
            <!-- Account/Email Payment Form -->
            <div id="accountPayment" class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recipient</label>
                    <input type="text" id="recipient" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Account number or email">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                    <input type="number" id="amount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note (Optional)</label>
                    <textarea id="note" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="What's this payment for?"></textarea>
                </div>
                
                <button onclick="sendMoney()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                    Send Money
                </button>
                
                <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                    <p class="text-xs text-yellow-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        This is a simulated transaction for educational purposes only.
                    </p>
                </div>
            </div>
            
            <!-- QR Code Payment Form -->
            <div id="qrPayment" class="p-6" style="display: none;">
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-32 h-32 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-qrcode text-gray-400 text-5xl"></i>
                    </div>
                    <p class="text-gray-600 mb-6">Scan a QR code to pay</p>
                    <button onclick="startQRScanner()" class="bg-blue-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-600 transition">
                        <i class="fas fa-camera mr-2"></i>Scan QR Code
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Money Screen -->
    <div id="request" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-green-500 text-white p-4 flex items-center">
                <button onclick="showScreen('home')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Request Money</h2>
            </div>
            
            <!-- Form -->
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">From</label>
                    <input type="text" id="requestRecipient" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Account number or email">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                    <input type="number" id="requestAmount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="0.00">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note (Optional)</label>
                    <textarea id="requestNote" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" rows="3" placeholder="What's this request for?"></textarea>
                </div>
                
                <button onclick="requestMoney()" class="w-full bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600 transition">
                    Send Request
                </button>
                
                <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                    <p class="text-xs text-yellow-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        This is a simulated request for educational purposes only.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Success Screen -->
    <div id="paymentSuccess" class="screen">
        <div class="phone-container bg-white">
            <div class="flex flex-col items-center justify-center min-h-screen p-6">
                <div class="mb-8 text-center">
                    <div id="successIcon" class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-green-500 text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Payment Successful!</h2>
                </div>
                
                <div class="w-full bg-gray-50 rounded-xl p-6 mb-6">
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">To:</span>
                        <span class="font-medium" id="successRecipient">Recipient</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Amount:</span>
                        <span class="font-medium big-amount text-blue-500" id="successAmount">₹0.00</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Note:</span>
                        <span class="font-medium" id="successNote">Payment</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Date:</span>
                        <span class="font-medium" id="successDate">Today</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Transaction ID:</span>
                        <span class="font-medium text-xs" id="successTransactionId">TXN123456789</span>
                    </div>
                </div>
                
                <div class="w-full space-y-3">
                    <button onclick="shareTransaction()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                        <i class="fas fa-share-alt mr-2"></i>Share
                    </button>
                    <button onclick="downloadPDFReceipt()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition">
                        <i class="fas fa-download mr-2"></i>Download Receipt
                    </button>
                    <button onclick="showScreen('home')" class="w-full border border-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-50 transition">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Details Screen -->
    <div id="transactionDetails" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-blue-500 text-white p-4 flex items-center">
                <button onclick="showScreen('history')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Transaction Details</h2>
            </div>
            
            <!-- Success Message -->
            <div id="transactionSuccessMessage" class="success-message mx-4 mt-4">
                <i class="fas fa-check-circle"></i>
                <span id="successMessageText">Transaction successful!</span>
            </div>
            
            <!-- Details -->
            <div class="p-6">
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">From:</span>
                        <span class="font-medium" id="detailFrom">Sender</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">To:</span>
                        <span class="font-medium" id="detailTo">Recipient</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Amount:</span>
                        <span class="font-medium text-xl" id="detailAmount">₹0.00</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Type:</span>
                        <span class="font-medium" id="detailType">Sent</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Note:</span>
                        <span class="font-medium" id="detailNote">Payment</span>
                    </div>
                    <div class="flex justify-between mb-3">
                        <span class="text-gray-600">Date:</span>
                        <span class="font-medium" id="detailDate">Today</span>
                    </div>
                    <div class="flex justify-between" id="detailTransactionIdRow" style="display: none;">
                        <span class="text-gray-600">Transaction ID:</span>
                        <span class="font-medium text-xs" id="detailTransactionId">TXN123456789</span>
                    </div>
                </div>
                
                <div class="w-full space-y-3">
                    <button onclick="shareTransaction()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                        <i class="fas fa-share-alt mr-2"></i>Share
                    </button>
                    <button onclick="downloadPDFReceipt()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition">
                        <i class="fas fa-download mr-2"></i>Download Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Screen -->
    <div id="history" class="screen">
        <div class="phone-container bg-gray-50 pb-20">
            <!-- Header -->
            <div class="bg-blue-500 text-white p-4">
                <h2 class="text-xl font-semibold">Transaction History</h2>
            </div>
            
            <!-- Transactions List -->
            <div class="p-4">
                <div id="historyTransactionsList" class="bg-white rounded-xl shadow-sm">
                    <p class="text-gray-500 text-center py-4">No transactions yet</p>
                </div>
            </div>
            
            <!-- Bottom Navigation -->
            <div class="bottom-nav bg-white border-t border-gray-200">
                <div class="grid grid-cols-4 py-2">
                    <button onclick="showScreen('home')" class="nav-btn flex flex-col items-center py-2 text-gray-500" id="homeNavBtn">
                        <i class="fas fa-home text-xl mb-1"></i>
                        <span class="text-xs">Home</span>
                    </button>
                    
                    <button onclick="showScreen('history')" class="nav-btn flex flex-col items-center py-2 text-blue-600" id="historyNavBtn">
                        <i class="fas fa-history text-xl mb-1"></i>
                        <span class="text-xs">History</span>
                    </button>
                    
                    <button onclick="showScreen('profile')" class="nav-btn flex flex-col items-center py-2 text-gray-500" id="profileNavBtn">
                        <i class="fas fa-user text-xl mb-1"></i>
                        <span class="text-xs">Profile</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="profile" class="screen">
        <div class="phone-container bg-gray-50 pb-20">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6">
                <div class="flex items-center mb-4">
                    <img id="profileIcon" src="https://picsum.photos/seed/user/200/200.jpg" class="w-20 h-20 rounded-full border-3 border-white mr-4">
                    <div>
                        <h2 class="text-xl font-bold" id="profileName">User</h2>
                        <p class="text-sm opacity-90" id="profileEmail">user@example.com</p>
                    </div>
                </div>
                
                <div class="bg-white/20 backdrop-blur rounded-xl p-4">
                    <p class="text-sm opacity-90" id="bankName">Children Bank of India</p>
                    <p class="text-lg font-bold mt-1" id="cardNumber">FPXXXX XXXX XXXX XXXX</p>
                    <p class="text-xs opacity-75 mt-1">Valid Thru: <span id="cardExpiry">12/28</span></p>
                </div>
            </div>
            
            <!-- Card Section -->
            <div class="px-6 mt-6">
                <h3 class="font-semibold text-gray-800 mb-3">Your Card</h3>
                <div class="debit-card p-6 text-white shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs opacity-75">Balance</p>
                            <p class="text-2xl font-bold" id="cardBalance">₹0.00</p>
                        </div>
                        <div class="chip"></div>
                    </div>
                    <div class="mt-8">
                        <p class="text-xs opacity-75">Card Holder</p>
                        <p class="text-lg font-medium" id="cardHolderName">USER</p>
                    </div>
                </div>
            </div>
            
            <!-- Profile Options -->
            <div class="px-6 mt-6">
                <h3 class="font-semibold text-gray-800 mb-3">Account Settings</h3>
                <div class="bg-white rounded-xl shadow-sm">
                    <button onclick="generateQRCode()" class="w-full p-4 flex items-center justify-between border-b border-gray-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-qrcode text-indigo-500"></i>
                            </div>
                            <span class="font-medium">Show QR Code</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <button onclick="showScreen('changePin')" class="w-full p-4 flex items-center justify-between border-b border-gray-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-lock text-blue-500"></i>
                            </div>
                            <span class="font-medium">Change PIN</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <button onclick="document.getElementById('profilePictureInput').click()" class="w-full p-4 flex items-center justify-between border-b border-gray-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-camera text-green-500"></i>
                            </div>
                            <span class="font-medium">Update Profile Picture</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <button onclick="signOut()" class="w-full p-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-sign-out-alt text-red-500"></i>
                            </div>
                            <span class="font-medium">Sign Out</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                </div>
            </div>
            
            <!-- Hidden file input for profile picture -->
            <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="uploadProfilePicture()">
            
            <!-- Bottom Navigation -->
            <div class="bottom-nav bg-white border-t border-gray-200">
                <div class="grid grid-cols-4 py-2">
                    <button onclick="showScreen('home')" class="nav-btn flex flex-col items-center py-2 text-gray-500" id="homeNavBtn">
                        <i class="fas fa-home text-xl mb-1"></i>
                        <span class="text-xs">Home</span>
                    </button>
                    
                    <button onclick="showScreen('history')" class="nav-btn flex flex-col items-center py-2 text-gray-500" id="historyNavBtn">
                        <i class="fas fa-history text-xl mb-1"></i>
                        <span class="text-xs">History</span>
                    </button>
                    
                    <button onclick="showScreen('profile')" class="nav-btn flex flex-col items-center py-2 text-blue-600" id="profileNavBtn">
                        <i class="fas fa-user text-xl mb-1"></i>
                        <span class="text-xs">Profile</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change PIN Screen -->
    <div id="changePin" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-blue-500 text-white p-4 flex items-center">
                <button onclick="showScreen('profile')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Change PIN</h2>
            </div>
            
            <!-- Form -->
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current PIN</label>
                    <input type="password" id="currentPin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pin-input" placeholder="••••" maxlength="4">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">New PIN</label>
                    <input type="password" id="newPin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pin-input" placeholder="••••" maxlength="4">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New PIN</label>
                    <input type="password" id="confirmNewPin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pin-input" placeholder="••••" maxlength="4">
                </div>
                
                <button onclick="changePin()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition">
                    Change PIN
                </button>
                
                <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                    <p class="text-xs text-yellow-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        Remember your PIN. You'll need it for all transactions.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Screen -->
    <div id="notifications" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-orange-500 text-white p-4 flex items-center">
                <button onclick="showScreen('home')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Notifications</h2>
            </div>
            
            <!-- Notifications List -->
            <div class="p-4">
                <div id="notificationsList" class="bg-white rounded-xl shadow-sm">
                    <p class="text-gray-500 text-center py-4">No notifications</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Show QR Code Screen -->
    <div id="showQR" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-indigo-500 text-white p-4 flex items-center">
                <button onclick="showScreen('profile')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Your QR Code</h2>
            </div>
            
            <!-- QR Code Display -->
            <div class="p-6">
                <div class="qr-container">
                    <div id="qrcode"></div>
                    
                    <div class="bg-gray-50 rounded-xl p-4 mt-6 w-full">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Account Number:</span>
                            <span class="font-medium" id="qrAccountNumber">FPXXXXXXXXX</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Name:</span>
                            <span class="font-medium" id="qrDisplayName">User Name</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Bank:</span>
                            <span class="font-medium" id="qrBankName">Children Bank of India</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-700 text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            Share this QR code to receive payments
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan QR Code Screen -->
    <div id="scanQR" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-indigo-500 text-white p-4 flex items-center">
                <button onclick="showScreen('home')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Scan QR Code</h2>
            </div>
            
            <!-- QR Scanner -->
            <div class="p-4">
                <div id="qr-reader"></div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-700 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        Position the QR code within the frame to scan
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Payment Screen -->
    <div id="qrPay" class="screen">
        <div class="phone-container bg-white">
            <!-- Header -->
            <div class="bg-indigo-500 text-white p-4 flex items-center">
                <button onclick="showScreen('home')" class="mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-xl font-semibold">Pay via QR Code</h2>
            </div>
            
            <!-- Recipient Details -->
            <div class="p-6">
                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Account Number:</span>
                        <span class="font-medium" id="qrPayAccountNumber">FPXXXXXXXXX</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Name:</span>
                        <span class="font-medium" id="qrPayDisplayName">User Name</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Bank:</span>
                        <span class="font-medium" id="qrPayBankName">Children Bank of India</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                    <input type="number" id="qrPayAmount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="0.00">
                </div>
                
                <button onclick="processQRPayment()" class="w-full bg-indigo-500 text-white py-3 rounded-lg font-medium hover:bg-indigo-600 transition">
                    Pay
                </button>
                
                <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                    <p class="text-xs text-yellow-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        You will be asked to enter your PIN to confirm this payment.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enable/disable proceed button based on disclaimer checkbox
        document.getElementById('disclaimerCheck').addEventListener('change', function() {
            const proceedBtn = document.getElementById('proceedBtn');
            proceedBtn.disabled = !this.checked;
        });
        
        // Load transactions for history screen
        function loadHistoryTransactions() {
            const transactionsRef = database.ref('transactions/' + currentUser.uid);
            transactionsRef.orderByChild('timestamp').limitToLast(20).on('value', snapshot => {
                const transactionsList = document.getElementById('historyTransactionsList');
                transactionsList.innerHTML = '';
                
                if (snapshot.exists()) {
                    const transactions = snapshot.val();
                    Object.keys(transactions).reverse().forEach(key => {
                        const transaction = transactions[key];
                        const transactionEl = createTransactionElement(transaction);
                        transactionsList.appendChild(transactionEl);
                    });
                } else {
                    transactionsList.innerHTML = '<p class="text-gray-500 text-center py-4">No transactions yet</p>';
                }
            });
        }
        
        // Override showScreen to load history transactions when needed
        const originalShowScreen = showScreen;
        showScreen = function(screenId) {
            originalShowScreen(screenId);
            
            if (screenId === 'history') {
                loadHistoryTransactions();
            }
        };
    </script>
</body>
</html>
